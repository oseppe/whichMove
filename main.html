<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="main.css">
	<title>Which Move</title>
</head>
<body>
	<header>
	</header>
	<main>
		<div class="row">
			<div id="pane-left" class="col s12 m6 l6 line-border">
				<!-- Canvas -->
				<div id="canvas-container" class="s12 m6 l6 center-align">
					<canvas id="canvas" height="300">
						Please update your browser or download the <a href="https://www.google.com/chrome/browser/desktop/index.html">latest Google Chrome browser</a>
					</canvas>	
				</div>
				<div class="s12 m6 l6">
					<!-- logo / branding -->
					<div id="" class="green accent-4">
						a
					</div>
					<!-- tally -->
					<div id="votes-tally" class="orange">
						a					
					</div>
					<!-- vote list -->
					<div id="votes-list" class="cyan accent-4 hide-on-small-only">
						a
					</div>
				</div>
			</div>
			<div id="pane-right" class="col s12 m6 l6">
				<div id="chat-ui">
					<!-- chat screen -->
					<div id="chat-screen" class="">
					</div>
					<!-- Run interface -->
					<div class="row">
						<div id="container-runner-input" class="col s12 m9 l9">
							<input id="runner-input" type="text" name="" placeholder="Run how many times?">
						</div>
						<div id="container-runner-send-btn" class="col m3 l3 hide-on-med-and-down">
							<button id="runner-run-btn" class="btn waves-effect" type="submit" name="action">
			    			RUN
			  			</button>
			  			<!--  -->
						</div>
					</div>
					<!-- Chat Interface -->
					<div class="row" style="display: none;">
						<div id="container-chat-input" class="col s12 m12 l12">
							<input id="chat-input" type="text" name="" placeholder="type in command">
						</div>
						<div id="container-chat-settings-btn" class="col s6 m6 l6 valign-wrapper" >
							<i id="btn-chat-settings" class="material-icons md-24">settings</i>
						</div>
						<div id="container-chat-send-btn" class="col s6 m6 l6">
							<button id="chat-send-btn" class="btn waves-effect" type="submit" name="action">
			    			chat
			  			</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
	<footer>
		
	</footer>
	<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
	<script type="text/javascript" src="js/sprite.js"></script>
	<script type="text/javascript" src="js/spriteHandler.js"></script>
	<script type="text/javascript" src="js/movesArbiter.js"></script>
	<script type="text/javascript" src="js/movesGenerator.js"></script>
	<script type="text/javascript">
		'use strict';

		let canvas = document.getElementById('canvas');

		let spriteHeight = 20;
		let spriteWidth = 20;
		let startY = computeCenter(canvas.height, spriteHeight);
		let startX = computeCenter(canvas.width, spriteWidth);
		
		const sprite = new Sprite(startX, startY, spriteWidth, spriteHeight);

    draw();

    const spriteHandler = new SpriteHandler(sprite, canvas.width, canvas.height);

    const movesArbiter = new MovesArbiter();

    const movesGenerator = new MovesGenerator();

		const runner = {
			run: function(times = 1, votesCount = 10, figureHandler) {

				setTimeout(function() {
					runner.startRound(votesCount);

					let stringifiedMove = movesArbiter.winner;

					figureHandler.move(stringifiedMove);
					showMessageInChatBox(stringifiedMove);
					showMessageInChatBox(movesArbiter.stringifyTally());

					movesArbiter.showTally();
					movesArbiter.clearMoves();

					if (times > 0) {
						times--;
						runner.run(times, votesCount, figureHandler);
					}

				}, 500);
			},

			startRound: function(votesCount) {
				for (let i = 0; i < votesCount; i++) {
					let stringifiedMove = movesGenerator.stringifiedMove;

					movesArbiter.addMove(stringifiedMove);
				}
			},
		}



		const createEntryForChatScreen = (message, name = 'anon', picURL = 'assets/luxSquare.png') => {
			let chatEntryDiv = document.createElement('div');
			let chatProfilePicContainer = document.createElement('div');
			let chatProfilePic = document.createElement('img');
			let chatProfileName = document.createElement('span');
			let chatEntryMessage = document.createElement('span');

			chatEntryDiv.setAttribute('class', 'chat-entry row valign-wrapper');
			chatProfilePicContainer.setAttribute('class', 'chat-profile-pic-container');
			chatProfilePic.setAttribute('class', 'chat-profile-pic');
			chatProfileName.setAttribute('class', 'chat-profile-name');
			chatEntryMessage.setAttribute('class', 'chat-entry-message');
			chatProfilePic.setAttribute('src', picURL);

			chatProfileName.innerHTML = name;
			chatProfilePicContainer.appendChild(chatProfilePic);
			chatEntryMessage.innerHTML = message;

			chatEntryDiv.appendChild(chatProfilePicContainer);
			chatEntryDiv.appendChild(chatProfileName);
			chatEntryDiv.appendChild(chatEntryMessage);

			return chatEntryDiv;
		}

		const showMessageInChatBox = (message) => {
			let chatScreen = document.getElementById('chat-screen');
			
			chatScreen.appendChild(createEntryForChatScreen(message));
			scrollToLatestEntry();
		}

		const sendChatUsingEnterKey = (event) => {
			if (event.keyCode == 13) {
				sendChat();
			}
		}

		const sendChat = () => {
			let chatBox = document.getElementById('chat-input');
			let message = chatBox.value;

			showMessageInChatBox(message);
			spriteHandler.move(message);
			chatBox.value = '';
		}

		const runRunner = () => {
			let input = document.getElementById('runner-input')
			// TODO: add validator
			let times = +(input.value);

			input.value = "";

			// TODO: Why the need for -1 to make the number of rounds correct?
			// TODO: Make votesCount editable via a settings object
			runner.run((times - 1), 30, spriteHandler);
		}

		const runRunnerUsingEnterKey = (event) => {
			if(event.keyCode == 13) {
				runRunner();
			}	
		}

		// Register events
		// Chat related events
		document.getElementById('chat-send-btn').addEventListener('click', sendChat);
		document.getElementById('chat-input').addEventListener('keypress', sendChatUsingEnterKey);

		// Runner related events
		document.getElementById('runner-run-btn').addEventListener('click', runRunner);
		document.getElementById('runner-input').addEventListener('keypress', runRunnerUsingEnterKey);

		// Functions
		function draw() {
      
      if (canvas.getContext) {
        let context = canvas.getContext('2d');

        context.clearRect(0,0, canvas.width, canvas.height);

        sprite.flicker().draw(context);

        window.requestAnimationFrame(draw);
      }
    }

    function computeCenter(canvasLength, figureLength) {
      return (canvasLength / 2) - (figureLength / 2);
    }

    function scrollToLatestEntry() {
    	let chatList = document.getElementById('chat-screen');

    	chatList.scrollTop = chatList.scrollHeight - chatList.clientHeight;
    }
	</script>
</body>
</html>