<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="main.css">
	<title>Which Move</title>
</head>
<body>
	<header>
		
	</header>
	<main>
		<div class=row>
			<canvas id='canvas'>
				Please update your browser or download the <a href="https://www.google.com/chrome/browser/desktop/index.html">latest Google Chrome browser</a>
			</canvas>
		</div>
		<div class=row>
			<div id="chat-screen" class="s12 m12 l12 teal">
				
			</div>
		</div>
		<!-- Run interface -->
		<div class="row valign-wrapper">
			<div id="container-runner-input" class="col s12 m10 l10">
				<input id="runner-input" type="text" name="" placeholder="Run how many times?">
			</div>
			<div id="container-runner-send-btn" class="col m2 l2 hide-on-small-only">
				<button id="runner-run-btn" class="btn waves-effect" type="submit" name="action">Run
    			<i class="material-icons right">send</i>
  			</button>
			</div>
		</div>
		<!-- Chat Interface -->
		<div class="row valign-wrapper" style="display: none;">
			<div id="container-chat-input" class="col s12 m10 l10">
				<input id="chat-input" type="text" name="" placeholder="type in command">
			</div>
			<div id="container-chat-send-btn" class="col m2 l2 hide-on-small-only">
				<button id="chat-send-btn" class="btn waves-effect" type="submit" name="action">Send
    			<i class="material-icons right">send</i>
  			</button>
			</div>
		</div>
	</main>
	<footer>
		
	</footer>
	<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/js/materialize.min.js"></script>
	<script type="text/javascript">
		'use strict';

		let canvas = document.getElementById('canvas');

    const sprite = {
      height: 10,
      width: 10,
      alpha: 1,
      alphaChange: 0.05,
      x: -2,
      y: -2,
      draw: function(ctx) {
        ctx.fillStyle = `rgba(39, 174, 96, ${this.alpha})`;
        ctx.fillRect(this.x, this.y, this.width, this.height);
        return this;
      },
      flicker: function() {
        if (this.alpha >= 1 || this.alpha <= 0) {
          this.alphaChange = this.alphaChange * -1;
        } 
        
        this.alpha = this.alpha + this.alphaChange;
        return this;
      },
      moveY: function(direction = 'up', canvasHeight) {
        let change = this.height * 0.10;

        if (direction === 'up') change = change * -1;

        let newY = this.y + change;

        if (direction === 'up') {
          newY = (newY < 0) ? 0 : newY;
        }        
        else if (direction === 'down') {
          let downBorder = canvasHeight - this.height;

          newY = (newY >= downBorder) ? downBorder : newY;
        }

        this.y = newY;

        return this;
      },
      moveX: function(direction = 'left', canvasWidth) {
        let change = this.width * 0.10;

        if (direction === 'left') change = change * -1;

        let newX = this.x + change;

        if (direction === 'left') {
          newX = (newX < 0) ? 0 : newX;
        }
        else if (direction === 'right') {
          let rightBorder = canvasWidth - this.width;

          newX = (newX >= rightBorder) ? rightBorder : newX;
        }

        console.log(`new X: ${newX}`)

        this.x = newX;

        return this;
      }
    }

    draw();

    const spriteHandler = {
    	figure: sprite,
    	canvasWidth: 0,
    	canvasHeight: 0,
    	move: function(direction) {
    		let lowerCaseDirection = direction.toLowerCase();

    		switch(lowerCaseDirection) {
					case 'left':
						this.figure.moveX('left', this.canvasWidth);
						break;
					case 'right':
						this.figure.moveX('right', this.canvasWidth);
						break;
					case 'up':
						this.figure.moveY('up', this.canvasHeight);
						break;
					case 'down':
						this.figure.moveY('down', this.canvasHeight);
						break;
				}
    	}
    }

    spriteHandler.canvasWidth = canvas.width;
    spriteHandler.canvasHeight = canvas.height;

		const movesGenerator = {
			stringify: function(move) {
				let stringifiedMove = "";

				switch(move) {
					case -2:
						stringifiedMove = "Down";
						break;
					case -1:
						stringifiedMove = "Left";
						break;
					case 0:
						stringifiedMove = "Stay";
						break;
					case 1:
						stringifiedMove = "Right";
						break;
					case 2:
						stringifiedMove = "Up";
						break;
				}

				return stringifiedMove;
			},

			getMove: function() {
				let min = -2;
				let max = 2;

				return Math.floor(Math.random() * (max - min + 1)) + min;
			},

			// Returns human readable move
			getMoveString: function() {
				return this.stringify(this.getMove());
			}
		};

		const runner = {
			run: function(times = 1, figureHandler) {

				console.log(`times: ${times}`);
				setTimeout(function() {
					let stringifiedMove = movesGenerator.getMoveString();

					figureHandler.move(stringifiedMove);
					showMessageInChatBox(stringifiedMove);

					if(times > 0) {
						times--;
						runner.run(times, figureHandler);
					}

				}, 500);
			},

			// delayShow: function(message) {
			// 	window.setTimeout(showMessageInChatBox(message), 3000);
			// }
		}

		const createEntryForChatScreen = (message) => {
			let entry = document.createElement("p");

			entry.innerHTML = message;

			return entry;
		}

		const showMessageInChatBox = (message) => {
			let chatScreen = document.getElementById('chat-screen');
			
			chatScreen.appendChild(createEntryForChatScreen(message));
			// console.log(message);
		}

		const sendChatUsingEnterKey = (event) => {
			if(event.keyCode == 13) {
				sendChat();
			}
		}

		const sendChat = () => {
			let chatBox = document.getElementById('chat-input');
			let message = chatBox.value;

			showMessageInChatBox(message);
			spriteHandler.move(message);
			chatBox.value = '';
		}

		const runRunner = () => {
			let input = document.getElementById('runner-input')
			// TODO: add validator
			let times = +(input.value);

			input.value = "";

			runner.run(times, spriteHandler);
		}

		const runRunnerUsingEnterKey = (event) => {
			if(event.keyCode == 13) {
				runRunner();
			}	
		}

		// Register events
		// Chat related events
		document.getElementById('chat-send-btn').addEventListener('click', sendChat);
		document.getElementById('chat-input').addEventListener('keypress', sendChatUsingEnterKey);

		// Runner related events
		document.getElementById('runner-run-btn').addEventListener('click', runRunner);
		document.getElementById('runner-input').addEventListener('keypress', runRunnerUsingEnterKey);

		// Functions
		function draw() {
      
      if (canvas.getContext) {
        let context = canvas.getContext('2d');

        context.clearRect(0,0, canvas.width, canvas.height);

        if (sprite.y === -2) sprite.y = computeCenter(canvas.height, sprite.height);
        if (sprite.x === -2) sprite.x = computeCenter(canvas.width, sprite.width);

        sprite.flicker().draw(context);

        window.requestAnimationFrame(draw);
      }
    }

    function computeCenter(canvasLength, figureLength) {
      return (canvasLength / 2) - (figureLength / 2);
    }
	</script>
</body>
</html>