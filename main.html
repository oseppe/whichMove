<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="main.css">
	<title>Which Move</title>
</head>
<body>
	<header>
	</header>
	<main>
		<div class="row">
			<div id="pane-left" class="col s12 m6 l6 line-border">
				<!-- Canvas -->
				<div id="canvas-container" class="s12 m6 l6 center-align">
					<canvas id="canvas" height="300">
						Please update your browser or download the <a href="https://www.google.com/chrome/browser/desktop/index.html">latest Google Chrome browser</a>
					</canvas>	
				</div>
				<div class="s12 m6 l6">
					<!-- win mode indicator -->
					<div id="mode-indicator-container" class="row">
						<div id="mode-indicator-content" class="col s12 center-align">
						<i class="material-icons orange-darken-4">stars</i>
						<span id="mode-indicator-text">1st to reach 4 votes</span>
						</div>
					</div>
					<!-- tally -->
					<div id="votes-tally" class="row center-align">
						<div id="votes-tally-margin-left" class="col s1">
							a
						</div>
						<div id="votes-tally-left" class="col s2">
							<i class="material-icons teal-darken-2">arrow_back</i>
							<div id="votes-count-left" class="votes-count">0</div>
						</div>
						<div id="votes-tally-up" class="col s2">
							<i class="material-icons teal-darken-2">arrow_upward</i>
							<div id="votes-count-up" class="votes-count">0</div>
						</div>
						<div id="votes-tally-right" class="col s2">
							<i class="material-icons teal-darken-2">arrow_forward</i>
							<div id="votes-count-right" class="votes-count">0</div>
						</div>
						<div id="votes-tally-down" class="col s2">
							<i class="material-icons teal-darken-2">arrow_downward</i>
							<div id="votes-count-down" class="votes-count">0</div>
						</div>
						<div id="votes-tally-stay" class="col s2">
							<i class="material-icons teal-darken-2">stop</i>
							<div id="votes-count-stay" class="votes-count">0</div>
						</div>
						<div id="votes-tally-margin-right" class="col s1">
							a
						</div>
					</div>
					<!-- vote list -->
					<div id="votes-list" class="hide-on-small-only">
					</div>
				</div>
			</div>
			<div id="pane-right" class="col s12 m6 l6">
				<div id="chat-ui">
					<!-- chat screen -->
					<div id="chat-screen" class="">
					</div>
					<!-- Chat Interface -->
					<div class="row">
						<div id="container-chat-input" class="col s12 m12 l12">
							<input id="chat-input" type="text" name="" placeholder="type in command">
						</div>
						<div id="container-chat-settings-btn" class="col s6 m6 l6 valign-wrapper" >
							<i id="btn-chat-settings" class="material-icons md-24 teal-darken-2">settings</i>
						</div>
						<div id="container-chat-send-btn" class="col s6 m6 l6">
							<button id="chat-send-btn" class="btn waves-effect" type="submit" name="action">
			    			chat
			  			</button>
						</div>
					</div>
				</div>
				<!-- Settings -->
				<div id="settings-container" class="row">
					<h5>Win Condition</h5>
					<div class="col s12">
						<p>
							<input name="winMode" type="radio" id="firstPastPost" value="0" checked />
							<label for="firstPastPost">1st to reach 4 votes</label>
						</p>
						<p>
							<input name="winMode" type="radio" id="mostVotesAfterSetTime" value="1" />
							<label for="mostVotesAfterSetTime">Most votes in 7s</label>
						</p>
					</div>
				</div>
			</div>
		</div>
	</main>
	<footer>
		
	</footer>
	<script type="text/javascript" src="js/observable.js"></script>
	<script type="text/javascript" src="js/user.js"></script>
	<script type="text/javascript" src="js/chatScreen.js"></script>
	<script type="text/javascript" src="js/modeIndicator.js"></script>
	<script type="text/javascript" src="js/movesArbiter.js"></script>
	<script type="text/javascript" src="js/movesGenerator.js"></script>
	<script type="text/javascript" src="js/rando.js"></script>
	<script type="text/javascript" src="js/runner.js"></script>
	<script type="text/javascript" src="js/settings.js"></script>
	<script type="text/javascript" src="js/speechGenerator.js"></script>
	<script type="text/javascript" src="js/sprite.js"></script>
	<script type="text/javascript" src="js/spriteHandler.js"></script>
	<script type="text/javascript" src="js/tallyBoard.js"></script>
	<script type="text/javascript" src="js/voteBoard.js"></script>
	<script type="text/javascript">
		'use strict';

		let canvas = document.getElementById('canvas');

		let spriteHeight = 20;
		let spriteWidth = 20;
		let startY = computeCenter(canvas.height, spriteHeight);
		let startX = computeCenter(canvas.width, spriteWidth);
		
		const sprite = new Sprite(startX, startY, spriteWidth, spriteHeight);

  	const spriteHandler = new SpriteHandler(sprite, canvas.width, canvas.height);

    const movesArbiter = new MovesArbiter();

    const chatScreenElem = document.getElementById('chat-screen');
		const chatScreen = new ChatScreen(chatScreenElem);

    const tallyBoardElem = document.getElementById('votes-tally');
    const tallyBoard = new TallyBoard(tallyBoardElem);

    const voteBoardElem = document.getElementById('votes-list');
    const voteBoard = new VoteBoard(voteBoardElem);

    const modeIndicatorElem = document.getElementById('mode-indicator-text');
    const modeIndicator = new ModeIndicator(modeIndicatorElem);

    const settingsWinModeElem = document.getElementsByName('winMode');
    const settings = new Settings(settingsWinModeElem);

		chatScreen.subscribe('addEntry', movesArbiter.chatCallback, movesArbiter);
		
		movesArbiter.subscribe('vote', voteBoard.movesArbiterVoteCallback, voteBoard);
		movesArbiter.subscribe('vote', tallyBoard.movesArbiterVoteCallback, tallyBoard);
		movesArbiter.subscribe('declareWinner', tallyBoard.movesArbiterDeclareWinnerCallback, tallyBoard);
		movesArbiter.subscribe('declareWinner', spriteHandler.movesArbiterDeclareWinnerCallback, spriteHandler);
		movesArbiter.subscribe('reset', tallyBoard.movesArbiterResetCallback, tallyBoard);

		settings.subscribe('winModeChanged', modeIndicator.settingsWinModeChangedCallback, modeIndicator);
		settings.subscribe('winModeChanged', movesArbiter.settingsWinModeChangedCallback, movesArbiter)

		const runnerInputElem = document.getElementById('runner-input');
		const runner = new Runner(chatScreen);

		const movesGenerator = new MovesGenerator();
    const speechGenerator = new SpeechGenerator();

		runner.addUser(new Rando('pen', 'assets/images/fireLuxSquare.png', movesGenerator, speechGenerator));
		runner.addUser(new Rando('paper', 'assets/images/stormLuxSquare.png', movesGenerator, speechGenerator));
		runner.addUser(new Rando('clip', 'assets/images/mysticLuxSquare.png', movesGenerator, speechGenerator));
		runner.addUser(new Rando('cord', 'assets/images/natureLuxSquare.png', movesGenerator, speechGenerator));

		runner.run();

		const sendChatUsingEnterKey = (event) => {
			if (event.keyCode == 13) {
				sendChat();
			}
		}

		const sendChat = () => {
			let chatBox = document.getElementById('chat-input');
			let message = chatBox.value;

			chatScreen.addEntry(message);
			chatBox.value = '';
		}

		draw();

		// Register events
		// Chat related events
		document.getElementById('chat-send-btn').addEventListener('click', sendChat);
		document.getElementById('chat-input').addEventListener('keypress', sendChatUsingEnterKey);

		// Functions
		function draw() {
	      
      if (canvas.getContext) {
        let context = canvas.getContext('2d');

        context.clearRect(0,0, canvas.width, canvas.height);

        sprite.flicker().draw(context);

        window.requestAnimationFrame(draw);
      }
    }

    function computeCenter(canvasLength, figureLength) {
      return (canvasLength / 2) - (figureLength / 2);
    }
	</script>
</body>
</html>